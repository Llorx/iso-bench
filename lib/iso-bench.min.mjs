const t=new Function("try {return this===window;}catch(e){ return false;}");class s{_browserWorker=null;_nodeWorker=null;constructor(s){t()?(s=`\nconst _d_ñ = v => v;\nconst _now_ñ = performance.now;\nconst _dif_ñ = d => _now_ñ() - d;\nconsole.log = (...args) => {\n    parent.postMessage({ log: args });\n};\n\r\n${s}`,this._browserWorker=new Worker(`data:text/javascript;charset=UTF-8,${encodeURIComponent(s)}`)):(s=`\nconst parent = require("worker_threads").parentPort;\nconst performance = require("perf_hooks").performance;\nconst _d_ñ = v => require("v8").deserialize(v);\nconst _now_ñ = process.hrtime.bigint;\nconst _dif_ñ = d => Number(_now_ñ() - d) / 1000000;\nconsole.log = (...args) => {\n    parent.postMessage({ log: args });\n};\nconst close = process.exit;\n\r\n${s}`,this._nodeWorker=new(require("worker_threads").Worker)(s,{eval:!0}))}addEventListener(t,s){this._browserWorker?this._browserWorker.addEventListener(t,s):this._nodeWorker.on(t,s)}postMessage(t){this._browserWorker?this._browserWorker.postMessage(t):this._nodeWorker.postMessage(require("v8").serialize(t))}}function e(t){return"clear"in t}function r(t){let s=t.toString(),e=s.substring(s.indexOf("(")+1,s.indexOf(")")).split(",").map((t=>t.trim())).filter((t=>!!t));s.startsWith("function")?s=s.substring(s.indexOf("{")+1,s.lastIndexOf("}")).trim():(s=s.substring(s.indexOf("=>")+2).trim(),s.startsWith("{")&&s.endsWith("}")&&(s=s.substring(1,s.length-1).trim()));let r=[];for(let t=0;t<e.length;t++)r.push(`let ${e[t]} = _args_ñ[${t}];`);return{args:e,body:s,evalArgs:r.join("\r\n")}}var n;!function(t){let n;!function(t){t.WORSE="WORSE",t.BEST="BEST",t.COMPLETED="[TESTS COMPLETED]"}(n=t.STRINGS||(t.STRINGS={}));t.Scope=class{_args;_setup;_scripts=[];_doneScripts=[];_loggedScripts=new Set;_logData=[];_running=0;_endCb=null;options;started=!1;constructor(t={},s,...e){this.options={parallel:1,ms:1e3,...t},this._setup=s?`let _args_ñ = await eval(${String(s)})(..._data_ñ.args);`:"",this._args=e}add(t,s){let e={name:t,samples:0,opMs:-1,totalTime:0,cycles:100,script:r(s)};return this._scripts.push(e),this._logData.push(e),this}log(...t){return this._logData.push({log:t}),this}output(...t){return this._logData.push({log:t,clear:!1}),this}result(...t){return this._logData.push({log:t,clear:!0}),this}run(){return new Promise(((t,s)=>{this.started?s(new Error("Already running")):(this.started=!0,this._endCb=t,this._checkOutput(),this._next())}))}_logPack(t){let s=this._doneScripts.slice();if(!t)for(let t of this._loggedScripts)s.splice(s.indexOf(t),1);let e=s.map((t=>t.opMs)),r=Math.min(...e.filter((t=>!!t))),o=Math.max(...e.filter((t=>!!t)));for(let e of s)this._loggedScripts.add(e),t&&e.opMs>0&&(e.log.push(`${(e.opMs/r).toFixed(3)}x`),e.log.push(`${e.opMs===r?n.WORSE:""}${e.opMs===o?n.BEST:""}`)),console.log(...e.log);t&&(this._doneScripts.splice(0),this._loggedScripts.clear())}_checkOutput(){for(;this._logData.length>0&&this._logData[0].log;)!("script"in this._logData[0])&&this._logData[0].log.length>0&&console.log(...this._logData[0].log),e(this._logData[0])&&this._logPack(this._logData[0].clear),this._logData.shift()}_next(){if(this._running<this.options.parallel){let t=this._scripts.shift();t?this._runWorker(t):(this._logPack(!1),console.log(n.COMPLETED),this._endCb&&this._endCb())}}_getWorkerScript(t){return`parent.addEventListener("message", async _event_ñ => {\n                try {\n                    const _data_ñ = _d_ñ(_event_ñ.data);\n                    ${this._setup}\n                    ${t.script.evalArgs}\n                    const _n_ñ = _now_ñ();\n                    for (let _i_ñ = 0; _i_ñ < ${t.cycles}; _i_ñ++) {\n                        ${t.script.body}\n                    }\n                    const _diff_ñ = _dif_ñ(_n_ñ);\n                    parent.postMessage({ diff: _diff_ñ });\n                } catch (e) {\n                    parent.postMessage({ error: String(e) });\n                }\n                close();\n            });`}_checkDataResult(t,s){if("log"in s)console.log(...s.log);else{if(this._running--,"error"in s)t.log=[t.name,"-",s.error],t.opMs=0,this._doneScripts.push(t),this._checkOutput();else{let e=s.diff;if(e<50){let s=50/e;t.cycles=Math.round(t.cycles*(s||50)),this._scripts.unshift(t)}else{t.samples++;let s=t.cycles/e;t.opMs=t.opMs<0?s:(t.opMs+s)/2,t.totalTime+=e,t.totalTime>this.options.ms?(t.log=[t.name,"-",Math.round(1e3*t.opMs).toLocaleString(),"op/s.",t.samples,"workers in",Math.round(t.totalTime),"ms."],this._doneScripts.push(t),this._checkOutput()):this._scripts.unshift(t)}}this._next()}}_runWorker(t){this._running++;let e=new s(this._getWorkerScript(t));e.addEventListener("message",(s=>{s.data?this._checkDataResult(t,s.data):this._checkDataResult(t,s)})),e.addEventListener("error",console.error),e.postMessage({args:this._args||[]})}}}(n||(n={}));export{n as IsoBench};
