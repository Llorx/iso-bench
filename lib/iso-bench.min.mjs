const t=new Function("try {return this===window;}catch(e){ return false;}"),s=o.toString().substring(o.toString().indexOf("{")+1,o.toString().lastIndexOf("}")),e=i.toString().substring(i.toString().indexOf("{")+1,i.toString().lastIndexOf("}"));class r{_browserWorker=null;_nodeWorker=null;constructor(r){t()?(r=`${s}\r\n${r}`,this._browserWorker=new Worker(`data:text/javascript;charset=UTF-8,${encodeURIComponent(r)}`)):(r=`${e}\r\n${r}`,this._nodeWorker=new(require("worker_threads").Worker)(r,{eval:!0}))}addEventListener(t,s){this._browserWorker?this._browserWorker.addEventListener(t,s):this._nodeWorker.on(t,s)}postMessage(t){this._browserWorker?this._browserWorker.postMessage(t):this._nodeWorker.postMessage(require("v8").serialize(t))}}function o(){console.log=(...t)=>{parent.postMessage({log:t})}}function i(){const t=require("worker_threads").parentPort;require("perf_hooks").performance,process.hrtime.bigint,console.log=(...s)=>{t.postMessage({log:s})},process.exit}function n(t){return"clear"in t}function a(t){let s=t.toString(),e=s.substring(s.indexOf("(")+1,s.indexOf(")")).split(",").map((t=>t.trim())).filter((t=>!!t));s.startsWith("function")?s=s.substring(s.indexOf("{")+1,s.lastIndexOf("}")).trim():(s=s.substring(s.indexOf("=>")+2).trim(),s.startsWith("{")&&s.endsWith("}")&&(s=s.substring(1,s.length-1).trim()));let r=[];for(let t=0;t<e.length;t++)r.push(`let ${e[t]} = _args_ñ[${t}];`);return{args:e,body:s,evalArgs:r.join("\r\n")}}var l;!function(t){let s;!function(t){t.WORSE="WORSE",t.BEST="BEST",t.COMPLETED="[TESTS COMPLETED]"}(s=t.STRINGS||(t.STRINGS={}));t.Scope=class{_args;_setup;_scripts=[];_doneScripts=[];_loggedScripts=new Set;_logData=[];_running=0;_endCb=null;options;started=!1;constructor(t={},s,...e){this.options={parallel:1,ms:1e3,...t},this._setup=s?`let _args_ñ = await eval(${String(s)})(..._data_ñ.args);`:"",this._args=e}add(t,s){let e={name:t,samples:0,opMs:-1,totalTime:0,cycles:100,script:a(s)};return this._scripts.push(e),this._logData.push(e),this}log(...t){return this._logData.push({log:t}),this}output(...t){return this._logData.push({log:t,clear:!1}),this}result(...t){return this._logData.push({log:t,clear:!0}),this}run(){return new Promise(((t,s)=>{this.started?s(new Error("Already running")):(this.started=!0,this._endCb=t,this._checkOutput(),this._next())}))}_logPack(t){let e=this._doneScripts.slice();if(!t)for(let t of this._loggedScripts)e.splice(e.indexOf(t),1);let r=e.map((t=>t.opMs)),o=Math.min(...r.filter((t=>!!t))),i=Math.max(...r.filter((t=>!!t)));for(let r of e)this._loggedScripts.add(r),t&&r.opMs>0&&(r.log.push(`${(r.opMs/o).toFixed(3)}x`),r.log.push(`${r.opMs===o?s.WORSE:""}${r.opMs===i?s.BEST:""}`)),console.log(...r.log);t&&(this._doneScripts.splice(0),this._loggedScripts.clear())}_checkOutput(){for(;this._logData.length>0&&this._logData[0].log;)!("script"in this._logData[0])&&this._logData[0].log.length>0&&console.log(...this._logData[0].log),n(this._logData[0])&&this._logPack(this._logData[0].clear),this._logData.shift()}_next(){if(this._running<this.options.parallel){let t=this._scripts.shift();t?this._runWorker(t):(this._logPack(!1),console.log(s.COMPLETED),this._endCb&&this._endCb())}}_getWorkerScript(t){return`parent.addEventListener("message", async _event_ñ => {\n                try {\n                    const _data_ñ = _d_ñ(_event_ñ.data);\n                    ${this._setup}\n                    ${t.script.evalArgs}\n                    const _n_ñ = _now_ñ();\n                    for (let _i_ñ = 0; _i_ñ < ${t.cycles}; _i_ñ++) {\n                        ${t.script.body}\n                    }\n                    const _diff_ñ = _dif_ñ(_n_ñ);\n                    parent.postMessage({ diff: _diff_ñ });\n                } catch (e) {\n                    parent.postMessage({ error: String(e) });\n                }\n                close();\n            });`}_checkDataResult(t,s){if("log"in s)console.log(...s.log);else{if(this._running--,"error"in s)t.log=[t.name,"-",s.error],t.opMs=0,this._doneScripts.push(t),this._checkOutput();else{let e=s.diff;if(e<50){let s=50/e;t.cycles=Math.round(t.cycles*(s||50)),this._scripts.unshift(t)}else{t.samples++;let s=t.cycles/e;t.opMs=t.opMs<0?s:(t.opMs+s)/2,t.totalTime+=e,t.totalTime>this.options.ms?(t.log=[t.name,"-",Math.round(1e3*t.opMs).toLocaleString(),"op/s.",t.samples,"workers in",Math.round(t.totalTime),"ms."],this._doneScripts.push(t),this._checkOutput()):this._scripts.unshift(t)}}this._next()}}_runWorker(t){this._running++;let s=new r(this._getWorkerScript(t));s.addEventListener("message",(s=>{s.data?this._checkDataResult(t,s.data):this._checkDataResult(t,s)})),s.addEventListener("error",console.error),s.postMessage({args:this._args||[]})}}}(l||(l={}));export{l as IsoBench};
